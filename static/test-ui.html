<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forecast Test UI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #f7f7f7; }
    section { background: #fff; border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 8px; }
    h2 { margin-top: 0; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    input, textarea, select { padding: 6px; min-width: 180px; }
    textarea { min-height: 80px; width: 360px; }
    button { padding: 6px 10px; cursor: pointer; }
    pre { background: #111; color: #e2e2e2; padding: 10px; overflow: auto; max-height: 260px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 4px; font-size: 13px; }
    #chart { width: 100%; height: 240px; background: #fff; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Forecast Debug Test UI</h1>

  <section>
    <h2>A) Health</h2>
    <div class="row">
      <button onclick="callApi('GET','/health',null,'outHealth')">GET /health</button>
      <button onclick="callApi('GET','/ready',null,'outHealth')">GET /ready</button>
    </div>
    <pre id="outHealth"></pre>
  </section>

  <section>
    <h2>B) Forecast DB introspection</h2>
    <div class="row">
      <button onclick="callApi('GET','/admin/db/tables',null,'outDb')">GET /admin/db/tables</button>
      <button onclick="callApi('GET','/admin/db/stats',null,'outDb')">GET /admin/db/stats</button>
      <button onclick="callApi('GET','/admin/cache/topic-samples?limit=50',null,'outDb')">GET /admin/cache/topic-samples</button>
    </div>
    <pre id="outDb"></pre>
  </section>

  <section>
    <h2>C) Predict</h2>
    <div class="row">
      <label>Date <input id="predictDate" type="date" /></label>
    </div>
    <div class="row">
      <label>Topics (one per line)<br /><textarea id="predictTopics"></textarea></label>
    </div>
    <div class="row">
      <button id="btnPredict">POST /predict</button>
      <span id="cacheMeta"></span>
    </div>
    <div class="row">
      <label>Topic from response <select id="topicSelect"></select></label>
    </div>
    <canvas id="chart" width="1000" height="240"></canvas>
    <table>
      <thead><tr><th>x</th><th>y</th></tr></thead>
      <tbody id="tablePreview"></tbody>
    </table>
    <pre id="outPredict"></pre>
  </section>

  <section>
    <h2>D) Cache coverage / select</h2>
    <div class="row">
      <label>Topic <input id="cacheTopic" /></label>
      <label>Date <input id="cacheDate" type="date" /></label>
      <label>Limit <input id="cacheLimit" type="number" value="200" /></label>
    </div>
    <div class="row">
      <button id="btnCoverage">GET /admin/cache/coverage</button>
      <button id="btnCacheSelect">POST /admin/cache/select</button>
    </div>
    <pre id="outCoverage"></pre>
  </section>

  <section>
    <h2>E) Manual generate</h2>
    <div class="row">
      <label>Date <input id="genDate" type="date" /></label>
      <label>Mode <select id="genMode"><option value="future">future</option><option value="history">history</option></select></label>
      <label>Write <input id="genWrite" type="checkbox" checked /></label>
    </div>
    <div class="row">
      <label>Topics<br /><textarea id="genTopics"></textarea></label>
    </div>
    <div class="row">
      <button id="btnGenerate">POST /admin/jobs/generate</button>
    </div>
    <pre id="outGenerate"></pre>
  </section>

  <section>
    <h2>F) Event log</h2>
    <div class="row"><button onclick="clearLog()">Clear log</button></div>
    <pre id="eventLog"></pre>
  </section>

<script>
  const $ = (id) => document.getElementById(id);

  function logEvent(entry) {
    const existing = $('eventLog').textContent;
    $('eventLog').textContent = `${entry}\n${existing}`;
  }

  function clearLog() { $('eventLog').textContent = ''; }

  async function callApi(method, url, payload, outId) {
    const start = performance.now();
    const headers = { 'Content-Type': 'application/json' };
    let response, responseText;
    try {
      response = await fetch(url, {
        method,
        headers,
        body: payload ? JSON.stringify(payload) : null,
      });
      responseText = await response.text();
    } catch (err) {
      const latency = (performance.now() - start).toFixed(1);
      $(outId).textContent = `Request failed: ${err}`;
      logEvent(`[${new Date().toISOString()}] ${method} ${url} status=ERR latency=${latency}ms payload=${JSON.stringify(payload || {})}`);
      return null;
    }

    const latency = (performance.now() - start).toFixed(1);
    let data;
    try { data = JSON.parse(responseText); } catch { data = responseText; }
    $(outId).textContent = JSON.stringify(data, null, 2);
    logEvent(`[${new Date().toISOString()}] ${method} ${url} status=${response.status} latency=${latency}ms payload=${JSON.stringify(payload || {})}`);
    return { response, data, latency };
  }

  function parseTopics(text) {
    return text.split('\n').map(s => s.trim()).filter(Boolean);
  }

  function drawChart(points) {
    const canvas = $('chart');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#333';
    ctx.strokeRect(0, 0, canvas.width, canvas.height);

    if (!points || points.length === 0) {
      ctx.fillStyle = '#666';
      ctx.fillText('No points', 10, 20);
      return;
    }

    const ys = points.map(p => Number(p.y) || 0);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const spanY = Math.max(1, maxY - minY);
    ctx.strokeStyle = '#1976d2';
    ctx.beginPath();

    points.forEach((p, i) => {
      const x = (i / Math.max(1, points.length - 1)) * (canvas.width - 20) + 10;
      const y = canvas.height - 10 - (((Number(p.y) || 0) - minY) / spanY) * (canvas.height - 20);
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
  }

  function renderTable(points) {
    const rows = (points || []).slice(0, 20).map(p => `<tr><td>${p.x}</td><td>${p.y}</td></tr>`).join('');
    $('tablePreview').innerHTML = rows;
  }

  function saveLocal() {
    localStorage.setItem('test_ui_date', $('predictDate').value);
    localStorage.setItem('test_ui_topics', $('predictTopics').value);
  }

  function loadLocal() {
    const today = new Date().toISOString().slice(0, 10);
    $('predictDate').value = localStorage.getItem('test_ui_date') || today;
    $('predictTopics').value = localStorage.getItem('test_ui_topics') || '';
    $('cacheDate').value = $('predictDate').value;
    $('genDate').value = $('predictDate').value;
    $('genTopics').value = $('predictTopics').value;
  }

  $('btnPredict').onclick = async () => {
    saveLocal();
    const payload = { prediction_date: $('predictDate').value, topics: parseTopics($('predictTopics').value) };
    const result = await callApi('POST', '/predict', payload, 'outPredict');
    if (!result) return;
    const data = result.data || {};
    const meta = data.meta || null;
    $('cacheMeta').textContent = meta ? `cache_hit=${meta.cache_hit} cache_miss=${meta.cache_miss}` : 'meta not present';

    const topics = Object.keys(data).filter(k => Array.isArray(data[k]));
    $('topicSelect').innerHTML = topics.map(t => `<option value="${t}">${t}</option>`).join('');
    const first = topics[0];
    const points = first ? data[first] : [];
    drawChart(points);
    renderTable(points);
  };

  $('topicSelect').onchange = () => {
    let parsed = {};
    try { parsed = JSON.parse($('outPredict').textContent || '{}'); } catch {}
    const points = parsed[$('topicSelect').value] || [];
    drawChart(points);
    renderTable(points);
  };

  $('btnCoverage').onclick = async () => {
    const q = new URLSearchParams({ topic: $('cacheTopic').value, date: $('cacheDate').value }).toString();
    await callApi('GET', `/admin/cache/coverage?${q}`, null, 'outCoverage');
  };

  $('btnCacheSelect').onclick = async () => {
    const payload = { topic: $('cacheTopic').value, date: $('cacheDate').value, limit: Number($('cacheLimit').value || 200) };
    await callApi('POST', '/admin/cache/select', payload, 'outCoverage');
  };

  $('btnGenerate').onclick = async () => {
    const payload = {
      prediction_date: $('genDate').value,
      topics: parseTopics($('genTopics').value),
      mode: $('genMode').value,
      write: $('genWrite').checked,
    };
    await callApi('POST', '/admin/jobs/generate', payload, 'outGenerate');
  };

  loadLocal();
</script>
</body>
</html>
